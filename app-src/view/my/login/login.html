<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../../dist/css/common/common.css" />
		<link rel="stylesheet" type="text/css" href="../../../dist/css/my/login.css" />
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">登录</h1>
		</header>
		<div class="mui-content">
			<form class="main">
				<a class="country-or-region">
					<span>
						国家/地区
					</span>
					<span>
						中国
					</span>
				</a>
				<div class="tel">
					+<label for="telNum">86</label>
					<input type="number" id="telNum" placeholder="输入手机号" />
				</div>

				<div class="vCode">
					<input type="text" id="vCode" placeholder="输入图形验证码" />
					<label class="vCodeItem"><!--ghuy--></label>
				</div>
				<div class="phoneCode">
					<input type="text" id="phoneCode" placeholder="输入手机验证码" />
					<!--<label class="phoneCodeItem" for="phoneCode">-->
					<button type="button" class="blue getCode">获取验证码</button>
					<!--</label>-->
				</div>
			</form>
			<div class="login">
				登录
			</div>
			<p class="prompt">未注册过的手机号将自动创建账号</p>
		</div>
	</body>

</html>
<script src="../../../lib/js/mui.min.js"></script>
<script src="../../../lib/js/h.min.js"></script>
<script src="../../../lib/js/zepto.min.js"></script>
<script type="text/javascript">
	mui.init();
	let countdown = 60;
	(function() {
		var Validata = {
			getVcodeUrl: 'http://192.168.31.2:7001/',
			getcodeUrl: 'http://192.168.31.2:7001/smsCaptcha',
			loginUrl: 'http://45.40.243.125:7001/login',
			phoneNumber: null,
			vCode: null,
			captcha: null,
			code: null,
			vCodeFlag: false,
			phoneCode: null,
			isEmpty: false,
			isClick: false,
			phoneFlag: false,
			regPhone: /^(13[0-9]|14[579]|15[0-3,5-9]|16[6]|17[0135678]|18[0-9]|19[89])\d{8}$/,
			gvCode: function gvCode() {
				let that = this;
				mui.ajax(that.getVcodeUrl, { //获取图形验证码
					type: 'GET',
					dataType: 'json',
					success: function(res) {
						console.log(res)
						$('.vCodeItem').html(res.body);
						that.captcha = res.code;
					},
					error: function(err) {
						console.log(err)
					}
				});
			},
			checkEmpty: function checkEmpty(val) {
				if(val) {
					this.isEmpty = true;
				} else {
					mui.alert('请输入图片验证码')
					this.isEmpty = false;
				}
			},
			checkPhone: function checkPhone(val) {
				if(this.regPhone.test(val)) {
					this.phoneFlag = true;
				} else {
					this.phoneFlag = false;
					mui.alert('请输入正确手机号');
				}
			},
			init: function init() {
				this.submitForm();
			},
			settime: function settime(ele) { //倒计时								
				if(countdown == 0) {
					$(ele).removeAttr("disabled");
					$(ele).text("获取验证码");
					countdown = 60;
					return;
				} else {
					$(ele).attr("disabled", true);
					$(ele).text(countdown + "s 重新发送 ");
					countdown--;
				};
				setTimeout(function() {
					settime(ele);
				}, 1000);
			},
			submitForm: function submitForm() {
				this.gvCode();
				let that = this;
				//请求图片验证码
				h('.vCodeItem').tap(function() {
					that.gvCode();
				})

				/*获取手机验证码进行图形验证码校验*/
				h('.getCode').tap(function(e) {
					e.preventDefault();
					that.phoneNumber = $('#telNum').val();
					that.vCode = $('#vCode').val();
					that.checkPhone(that.phoneNumber);
					if(that.phoneFlag) {
						that.checkEmpty(that.vCode);
						if(that.isEmpty) {
							//if(that.vCode == that.captcha) {
							//if(eval("/^" + that.captcha + "$/i").test(that.vCode)) {
							that.vCodeFlag = true;
							that.isClick = true;
							that.settime('.getCode');
							mui.ajax(that.getcodeUrl, {
								type: 'GET',
								dataType: 'json',
								data: {
									mobile: that.phoneNumber,
									captcha: that.vCode
								},
								success: function(res) {
									console.log(res);
									if(res.body.status != 202) {
										that.vCodeFlag = false;
										that.isClick = false;
										alert('图形验证码错误!');
									} else {
										that.vCodeFlag = true;
										that.isClick = true;
										that.settime('.getCode');
										alert('图形验证码正确,获取手机验证码');
										/*登录*/
									}
								},
								error: function(err) {
									console.log(err + '错误');
								}
							})
							//								mui.ajax(that.getcodeUrl, { //获取手机验证码
							//									type: 'GET',
							//									dataType: 'json',
							//									data: {
							//										mobile: that.phoneNumber
							//									},
							//									success: function(res) {
							//										console.log(res)
							//									},
							//									error: function(err) {
							//										console.log(err);
							//									}
							//								})
							/*} else {
								that.vCodeFlag = false;
								that.isClick = false;
								mui.alert('图形验证码错误,请重新输入')
							};*/
							//							mui.ajax('http://192.168.31.2:7001/smsCaptcha', {
							//								type: 'GET',
							//								dataType: 'json',
							//								data: {
							//									mobile: that.phoneNumber,
							//									captcha: that.vCode
							//								},
							//								success: function(res) {
							//									console.log(res)
							//									if(res.body.code != 202) {
							//										that.vCodeFlag = false;
							//										that.isClick = false;
							//										alert('图形验证码错误!');
							//									} else {
							//										that.vCodeFlag = true;
							//										that.isClick = true;
							//										that.settime('.getCode');
							//										alert('图形验证码正确,获取手机验证码');
							//										/*登录*/
							//									}
							//								},
							//								error: function(err) {
							//									console.log(err);
							//								}
							//							})
						}
					}
				});
				h('.login').tap(function() {
					that.code = $('#phoneCode').val();
					if(that.isClick && that.vCodeFlag) {
						mui.ajax(that.loginUrl, { //进行验证登录操作
							type: 'GET',
							dataType: 'json',
							data: {
								mobile: that.phoneNumber,
								code: that.code,
								address: '456456'
							},
							success: function(res) {
								console.log(JSON.stringify(res))
								if(res.body.status == 200) {
									plus.storage.setItem("token", res.body.data.token)
									plus.webview.show(plus.webview.getWebviewById('index.html'));
								}
							},
							error: function(err) {
								console.log('Error+' + JSON.stringify(err));
							}
						});
					} else {
						mui.alert('请先进行验证!');
					}
				})
			}
		};
		Validata.init();
	})();
</script>