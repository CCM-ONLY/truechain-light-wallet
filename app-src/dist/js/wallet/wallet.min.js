"use strict";

//页面跳转
mui.plusReady(function() {

	(function() {
		let host = plus.storage.getItem('web3Host');
		let trueContractAddr, ttrContractAddr;
		let reg = /https:\/\/ropsten.infura.io/;
		if(!host) {
			host = 'https://mainnet.infura.io/';
			trueContractAddr = "0xa4d17ab1ee0efdd23edc2869e7ba96b89eecf9ab";
			ttrContractAddr = "0xf2bb016e8c9c8975654dcd62f318323a8a79d48e";
		} else if(reg.test(host)) {
			trueContractAddr = "0x2792d677B7Ba6B7072bd2293F64BC0C1CDe23ac1";
			ttrContractAddr = "0x635AfeB8739f908A37b3d312cB4958CB2033F456";
		} else {
			trueContractAddr = "0xa4d17ab1ee0efdd23edc2869e7ba96b89eecf9ab";
			ttrContractAddr = "0xf2bb016e8c9c8975654dcd62f318323a8a79d48e";
		}

		var web3 = new Web3(new Web3.providers.HttpProvider(host));

		var Wallet = {
			init: function init() {
				var that = this;
				//页面跳转
				this.turnUrl(".e-setup", "setup.html", "setup");
				this.turnUrl(".e-import", "importwallet.html", "importwallet");

				//获取资产情况
				var addresses = plus.storage.getItem('walletAddress');
				web3.eth.getBalance(addresses).then(function(res) {
					var balance = res;
					balance = that.show(web3.utils.fromWei(balance, 'ether'));
					//钱包列表
					let string = `<li class='mywallet'>
					<section>
						<i class="avatar"></i>
						<div class="wallet-info">
							<p class="title">${plus.storage.getItem('walletName')}</p>
							<p class="code">${plus.storage.getItem('walletAddress')}</p>
						</div>
						<span class="mui-navigate-right"></span>
					</section>
					<section>
						<span>${balance}<i>ether</i></span>
					</section>
				</li>`;
					$('.wallet-list').append(string);
					that.turnUrl(".mywallet", "../../asset/userinfo.html", "userinfo");
				});
			},
			turnUrl: function turnUrl(elements, url, id) {
				$(elements).on('tap', function() {
					openInfo(url, id);
				});
			},
			show: function show(num) {
				num += '';
				num = num.replace(/[^0-9|\.]/g, '');
				if(/^0+/) {
					num = num.replace(/^0+/, '');
				};
				if(!/\./.test(num)) {
					num += '.00000';
				};
				if(/^\./.test(num)) {
					num = '0' + num;
				};
				num += '00000';
				num = num.match(/\d+\.\d{5}/)[0];
				return num
			}
		};
		Wallet.init();
	})();
})