"use strict";
mui.plusReady(function() {
	let host = plus.storage.getItem('web3Host');
	if(!host) {
		host = 'https://mainnet.infura.io/';
	}

	(function() {
		var nameObj = GetRequest();
		var currencyName = nameObj['name'],
			scanningAddress = nameObj['scanningAddress'];
		if(currencyName || scanningAddress) {
			h('.mui-title').html(currencyName + '转账');
			h('#toAddress').val(scanningAddress);
		}

		function GetRequest() {
			var url = location.search; //获取url中"?"符后的字串
			var theRequest = new Object();
			if(url.indexOf("?") != -1) {
				var str = url.substr(1);
				var strs = str.split("&");
				for(var i = 0; i < strs.length; i++) {
					theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
				}
			}
			return theRequest;
		}

		var web3 = new Web3();
		var Validata = {
			//初始化
			add: null,
			money: null,
			//	remark:null,
			cost: null,
			psw: null,
			pwd: null,
			isEmpty: true,
			regMoney: /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]{3}([0-9])?$)/,
			fromAddress: null,
			toAddress: null,
			amount: null,
			//验证是否通过
			addFlag: false,
			moneyFlag: false,
			costFlag: false,
			pswFlag: false,
			init: function init() {
				this.submitForm();
			},
			checkEmpty: function checkEmpty(val) {
				if(val) {
					this.isEmpty = false;
				} else {
					this.isEmpty = true;
				}
			},
			checkAdd: function checkAdd(elements, errContainer) {
				this.addFlag = false;
				this.add = $(elements).val();
				this.checkEmpty(this.add);
				if(this.isEmpty) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("钱包地址不能为空");
					return;
				} else {
					this.addFlag = true;
					$(errContainer).addClass("mui-hidden");
					$(errContainer).text("");
					return;
				}
				return this;
			},
			checkMoney: function checkMoney(elements, errContainer) {
				this.moneyFlag = false;
				this.money = $(elements).val();
				this.checkEmpty(this.money);
				if(this.isEmpty) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("转账不能为空");
					return;
				} else if(!this.regMoney.test(this.money)) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("请输入正确转账金额");
					return;
				} else {
					this.moneyFlag = true;
					$(errContainer).addClass("mui-hidden");
					$(errContainer).text("");
				}
				return this;
			},
			//		checkCost: function checkCost(elements, errContainer) {
			//			this.costFlag = false;
			//			this.cost = $(elements).val();
			//			this.checkEmpty(this.cost);
			//			if(this.isEmpty) {
			//				$(errContainer).removeClass("mui-hidden");
			//				$(errContainer).text("矿工费用不能为空");
			//				return;
			//			} else if(!(this.regMoney).test(this.cost)) {
			//				$(errContainer).removeClass("mui-hidden");
			//				$(errContainer).text("请输入正确矿工费用")
			//				return;
			//			} else {
			//				this.costFlag = true;
			//				$(errContainer).addClass("mui-hidden");
			//				$(errContainer).text("");
			//			}
			//			return this;
			//		},
			checkPwd: function checkPwd(elements, errContainer) {
				this.pswFlag = false;
				this.pwd = $(elements).val();
				this.checkEmpty(this.pwd);
				if(this.isEmpty) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("密码不能为空");
					return;
				} else {
					this.pswFlag = true;
					$(errContainer).addClass("mui-hidden");
					$(errContainer).text("");
				}
				return this;
			},
			submitForm: function submitForm() {
				var that = this;
				var flag = false;
				var mask = mui.createMask(function() {
					return flag;
				});
				//二维码按钮
				$('.ercode-icon').on('tap', function() {
					openInfo('../my/wallet/ercode.html');
				});
				//下一步
				$('#next').on('tap', function() {
					that.checkAdd('.add', '.err-add');
					that.checkMoney('.money', '.err-money');
					if(that.addFlag && that.moneyFlag) {
						flag = false;
						mask.show();
						$('#modal').addClass('mui-active');
						//$('#currencyPwd').removeClass('mui-hidden');
						//$('#currencyPwd').addClass('mui-active');
						that.amount = $('#amount').val();
						that.fromAddress = plus.storage.getItem('walletAddress');
						that.toAddress = $('#toAddress').val();
						that.minerCost = $('#minerCost').html();
						$('#toaddressItem').html(that.toAddress);
						$('#fromAddress').html(that.fromAddress);
						$('#amountItem').html(that.amount);
						$('#minerCostItem').html(that.minerCost + 'ETH');
						let string = "≈ Gas(25200) * Gas Price(" + Math.round((that.minerCost / 0.00002520) * 100) / 100 + "   gwei)";
						$('.costItem').html(string)
					}
				});

				$('#confirmOrder').on('tap', function() {
					$('#modal').addClass('mui-hidden');
				})

				//最后确认支付按钮(跳转到支付页面)
				$('.comfirmPsw').on('tap', function() {
					that.checkPwd('.psw', '.err-psw');
					mask.show();
					$('#currencyPwd').addClass('mui-hidden');

					if(that.pswFlag) {
						//$('#currencyPwd').addClass('mui-hidden');
						//$('#currencyPwd').removeClass('mui-active');
						//$('#modal').addClass('mui-active');					
						function sendEth() {
							var serialized_keystore = plus.storage.getItem('keystore');
							var keystore = lightwallet.keystore.deserialize(serialized_keystore);
							keystore.keyFromPassword(that.pwd, function(err, pwDerivedKey) {
								if(err) {
									console.log(err, '56565699999999');
									if(err == 'Error: invalid address') {
										mui.alert('无效地址');
									} else if(err == "Error: Incorrect derived key!") {
										mui.alert('密码错误,请重新输入!')
									}
									$('#currencyPwd').removeClass('mui-hidden');
								} else {
									var totalAddresses = 1;
									keystore.generateNewAddress(pwDerivedKey, totalAddresses);
									var addresses = keystore.getAddresses(),
										address = addresses[0],
										privateKey = keystore.exportPrivateKey(address, pwDerivedKey),
										fromAddr = that.fromAddress,
										toAddr = that.toAddress,
										valueEth = that.amount,
										value = parseFloat(valueEth) * 1.0e18,
										gasPrice = 21000000000,
										gas = 25200;

									web3.eth.sendTransaction({
											from: fromAddr,
											to: toAddr,
											value: value,
											gasPrice: gasPrice,
											gas: gas
										},
										function(err, txhash) {
											if(err) {
												mui.alert('交易失败原因:ETH不足!');
												$('#currencyPwd').removeClass('mui-hidden');
											} else {
												mui.toast('交易成功');
												mui.openWindow('dealsuccessful.html');
											}
											console.log('error: ' + err);
											console.log('txhash: ' + txhash);
										})
								}
							});
						}
						if(currencyName == 'ETH') {
							sendEth();
							console.log('ETH转账')
						} else if(currencyName == 'TRUE') {
							function sendToken(fromAddr, toAddr, valueToken, pwd) {
								mui.plusReady(function() {
									let host = plus.storage.getItem('web3Host');
									if(!host) {
										host = 'https://mainnet.infura.io/';
									}
									console.log('发送代币执行!');
									//var fromAddr = '0x5833fa6053e6e781eafb8695d63d90f6b3571e5e';
									//var toAddr = '0x10592A6daD0055c586bb95474e7056F72462997A';
									var amount = parseFloat(valueToken) * 1.0e18,
										gasPrice = 21000000000,
										gas = 110000,
										privateKey;

									//合约的interface
									var abi = [{
										"constant": true,
										"inputs": [],
										"name": "name",
										"outputs": [{
											"name": "",
											"type": "string"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": true,
										"inputs": [],
										"name": "totalSupply",
										"outputs": [{
											"name": "supply",
											"type": "uint256"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": false,
										"inputs": [{
											"name": "_from",
											"type": "address"
										}, {
											"name": "_to",
											"type": "address"
										}, {
											"name": "_value",
											"type": "uint256"
										}],
										"name": "transferFrom",
										"outputs": [{
											"name": "success",
											"type": "bool"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": true,
										"inputs": [],
										"name": "decimals",
										"outputs": [{
											"name": "",
											"type": "uint256"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": true,
										"inputs": [{
											"name": "_owner",
											"type": "address"
										}],
										"name": "balanceOf",
										"outputs": [{
											"name": "balance",
											"type": "uint256"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": true,
										"inputs": [],
										"name": "symbol",
										"outputs": [{
											"name": "",
											"type": "string"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": false,
										"inputs": [{
											"name": "_to",
											"type": "address"
										}, {
											"name": "_value",
											"type": "uint256"
										}],
										"name": "transfer",
										"outputs": [{
											"name": "success",
											"type": "bool"
										}],
										"payable": false,
										"type": "function"
									}, {
										"constant": true,
										"inputs": [{
											"name": "_owner",
											"type": "address"
										}, {
											"name": "_spender",
											"type": "address"
										}],
										"name": "allowance",
										"outputs": [{
											"name": "remaining",
											"type": "uint256"
										}],
										"payable": false,
										"type": "function"
									}, {
										"anonymous": false,
										"inputs": [{
											"indexed": true,
											"name": "_from",
											"type": "address"
										}, {
											"indexed": true,
											"name": "_to",
											"type": "address"
										}, {
											"indexed": false,
											"name": "_value",
											"type": "uint256"
										}],
										"name": "Transfer",
										"type": "event"
									}, {
										"anonymous": false,
										"inputs": [{
											"indexed": true,
											"name": "_owner",
											"type": "address"
										}, {
											"indexed": true,
											"name": "_spender",
											"type": "address"
										}, {
											"indexed": false,
											"name": "_value",
											"type": "uint256"
										}],
										"name": "Approval",
										"type": "event"
									}]

									var contractAddr = '0xa4d17ab1ee0efdd23edc2869e7ba96b89eecf9ab' //TRUE合约地址

									var serialized_keystore = plus.storage.getItem('keystore');
									var keystore = lightwallet.keystore.deserialize(serialized_keystore) //将序列号的keystore转换为对象  

									var password = pwd;

									keystore.keyFromPassword(password, function(err, pwDerivedKey) {
										//console.log(pwDerivedKey) ;
										if(err) {
											console.log(err);
											mui.alert('密码错误,请重新输入!');
											mask._remove();
										} else {
											var totalAddresses = 1;
											keystore.generateNewAddress(pwDerivedKey, totalAddresses);
											var addresses = keystore.getAddresses();
											var address = addresses[0];
											console.log(address);
											privateKey = keystore.exportPrivateKey(address, pwDerivedKey);
											console.log('privateKey' + privateKey);

											var web3Provider = new HookedWeb3Provider({
												//host: "http://localhost:8545", 				// 私链 
												//host: "https://rinkeby.infura.io/",		// 以太坊测试  
												//host: "https://ropsten.infura.io/", // 以太坊测试 (ropsten) 
												host: host, // 以太坊正式网 
												transaction_signer: {
													hasAddress: function(address, callback) {
														callback(null, true);
													},
													signTransaction: function(tx_params, callback) {
														var rawTx = {
															gasPrice: web3.toHex(tx_params.gasPrice),
															gasLimit: web3.toHex(tx_params.gas),
															value: web3.toHex(tx_params.value),
															from: tx_params.from,
															to: tx_params.to,
															nonce: web3.toHex(tx_params.nonce),
															data: web3.toHex(tx_params.data)
														};
														console.log(JSON.stringify(rawTx), '========')
														console.log('tx_params_data: ' + tx_params.data)

														var tx = new ethereumjs.Tx(rawTx);
														var privateKeye = new ethereumjs.Buffer.Buffer(privateKey, 'hex');

														tx.sign(privateKeye);
														var serializedTx = '0x' + tx.serialize().toString('hex');

														callback(null, serializedTx);
													}
												}
											});

											var web3 = new Web3(web3Provider);

											var MyContract = web3.eth.contract(abi);
											var myContractInstance = MyContract.at(contractAddr);

											toAddr = toAddr.substring(2);
											amount = web3.fromDecimal(amount);
											amount = amount.substring(2);
											amount = PreFixInterge(amount, 32);

											var data = '0x' + 'a9059cbb' + '000000000000000000000000' + toAddr + '00000000000000000000000000000000' + amount;

											console.log(data);

											web3.eth.sendTransaction({
													from: fromAddr,
													to: contractAddr,
													value: '0x00',
													gasPrice: gasPrice,
													gas: gas,
													data: data
												},
												function(err, txhash) {
													if(err) {
														mui.alert('交易失败原因: 无效地址或密码错误或ETH不足,请重试!');
														mask._remove();
													} else {
														mui.toast('交易成功');
														mui.openWindow('dealsuccessful.html');
													}
													console.log('error: ' + err);
													console.log('txhash: ' + txhash);
												})

											function PreFixInterge(num, n) {
												//num代表传入的数字，n代表要保留的字符的长度  
												return(Array(n).join(0) + num).slice(-n);
											}
										}

									});

								})
							};
							sendToken(that.fromAddress, that.toAddress, that.amount, that.pwd)

							console.log('TRUE转账')
						}
					}
				});
				//关闭按钮
				$('.close').on('tap', function(e) {
					flag = true;
					mask.close();
					$('#currencyPwd').removeClass('mui-active');
					$('#modal').removeClass('mui-active');
				});
				//确定支付详情
				$('#confirmOrder').on('tap', function() {
					$('#currencyPwd').removeClass('mui-hidden');
					$('#currencyPwd').addClass('mui-active');
					//openInfo('dealsuccessful.html');
				});
			}
		};

		Validata.init();
	})();

})