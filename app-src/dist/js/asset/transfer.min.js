"use strict";

(function() {
	var nameObj = GetRequest();
	var currencyName = nameObj['name'],
		scanningAddress = nameObj['scanningAddress'];
	if(currencyName || scanningAddress) {
		h('.mui-title').html(currencyName + '转账');
		h('#toAddress').val(scanningAddress);
	}

	function GetRequest() {
		var url = location.search; //获取url中"?"符后的字串
		var theRequest = new Object();
		if(url.indexOf("?") != -1) {
			var str = url.substr(1);
			var strs = str.split("&");
			for(var i = 0; i < strs.length; i++) {
				theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
			}
		}
		return theRequest;
	}

	var web3 = new Web3();
	var Validata = {
		//初始化
		add: null,
		money: null,
		//	remark:null,
		cost: null,
		psw: null,
		pwd: null,
		isEmpty: true,
		regMoney: /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/,
		fromAddress: null,
		toAddress: null,
		amount: null,
		//验证是否通过
		addFlag: false,
		moneyFlag: false,
		costFlag: false,
		pswFlag: false,
		init: function init() {
			this.submitForm();
		},
		checkEmpty: function checkEmpty(val) {
			if(val) {
				this.isEmpty = false;
			} else {
				this.isEmpty = true;
			}
		},
		checkAdd: function checkAdd(elements, errContainer) {
			this.addFlag = false;
			this.add = $(elements).val();
			this.checkEmpty(this.add);
			if(this.isEmpty) {
				$(errContainer).removeClass("mui-hidden");
				$(errContainer).text("钱包地址不能为空");
				return;
			} else {
				this.addFlag = true;
				$(errContainer).addClass("mui-hidden");
				$(errContainer).text("");
				return;
			}
			return this;
		},
		checkMoney: function checkMoney(elements, errContainer) {
			this.moneyFlag = false;
			this.money = $(elements).val();
			this.checkEmpty(this.money);
			if(this.isEmpty) {
				$(errContainer).removeClass("mui-hidden");
				$(errContainer).text("转账不能为空");
				return;
			} else if(!this.regMoney.test(this.money)) {
				$(errContainer).removeClass("mui-hidden");
				$(errContainer).text("请输入正确转账金额");
				return;
			} else {
				this.moneyFlag = true;
				$(errContainer).addClass("mui-hidden");
				$(errContainer).text("");
			}
			return this;
		},

		//		checkCost(elements,errContainer){
		//			this.costFlag = false;
		//			this.cost = $(elements).val();
		//			this.checkEmpty(this.cost);
		//			if(this.isEmpty){
		//				$(errContainer).removeClass("mui-hidden");
		//				$(errContainer).text("矿工费用不能为空");
		//				return;
		//			}else if(!(this.regMoney).test(this.cost)){
		//				$(errContainer).removeClass("mui-hidden");
		//				$(errContainer).text("请输入正确矿工费用")
		//			 	return;
		//			}else{
		//				this.costFlag = true;
		//				$(errContainer).addClass("mui-hidden");
		//				$(errContainer).text("");
		//			}
		//			return this;
		//		},
		checkPwd: function checkPwd(elements, errContainer) {
			this.pswFlag = false;
			this.pwd = $(elements).val();
			this.checkEmpty(this.pwd);
			if(this.isEmpty) {
				$(errContainer).removeClass("mui-hidden");
				$(errContainer).text("密码不能为空");
				return;
			} else {
				this.pswFlag = true;
				$(errContainer).addClass("mui-hidden");
				$(errContainer).text("");
			}
			return this;
		},
		submitForm: function submitForm() {
			var that = this;
			var flag = false;
			var mask = mui.createMask(function() {
				return flag;
			});
			//二维码按钮
			$('.ercode-icon').on('tap', function() {
				openInfo('../my/wallet/ercode.html');
			});
			//下一步
			$('#next').on('tap', function() {
				that.checkAdd('.add', '.err-add');
				that.checkMoney('.money', '.err-money');
				if(that.addFlag && that.moneyFlag) {
					flag = false;
					mask.show();
					$('#modal').addClass('mui-active');
					//$('#currencyPwd').removeClass('mui-hidden');
					//$('#currencyPwd').addClass('mui-active');
					that.amount = $('#amount').val();
					that.fromAddress = plus.storage.getItem('walletAddress');
					that.toAddress = $('#toAddress').val();
					document.getElementById('toaddressItem').innerHTML = that.toAddress;
					document.getElementById('fromAddress').innerHTML = '0x' + that.fromAddress;
					document.getElementById('amountItem').innerHTML = that.amount;
				}
			});
			//最后确认支付按钮(跳转到支付页面)
			$('.comfirmPsw').on('tap', function() {
				that.checkPwd('.psw', '.err-psw');
				if(that.pswFlag) {
					//					$('#currencyPwd').addClass('mui-hidden');
					//					$('#currencyPwd').removeClass('mui-active');
					//					$('#modal').addClass('mui-active');

					function sendEth() {
						var serialized_keystore = plus.storage.getItem('keystore');
						var keystore = lightwallet.keystore.deserialize(serialized_keystore); //将序列号的keystore转换为对象 

						keystore.keyFromPassword(that.pwd, function(err, pwDerivedKey) {
							if(err) {
								mui.alert('密码错误!')
							} else {
								function setWeb3Provider(keystore) {
									var web3Provider = new HookedWeb3Provider({
										//host: "http://localhost:8545", // 私链 
										//host: "https://rinkeby.infura.io/",		// 以太坊测试  
										//host: "https://ropsten.infura.io/", // 以太坊测试 (ropsten)
										host: "https://mainnet.infura.io/", // 以太坊测正式
										transaction_signer: keystore
									});
									web3.setProvider(web3Provider);
								}
								setWeb3Provider(keystore);
								var fromAddr = that.fromAddress;
								var toAddr = that.toAddress;
								var valueEth = that.amount;
								var value = parseFloat(valueEth) * 1.0e18;
								var gasPrice = 21000000000;
								var gas = 110000;
								web3.eth.sendTransaction({
										from: fromAddr,
										to: toAddr,
										value: value,
										gasPrice: gasPrice,
										gas: gas
									},
									function(err, txhash) {
										console.log('error: ' + err);
										console.log('txhash: ' + txhash);
										mask.show();
										if(err) {
											//sendToken()
											mui.alert('交易失败!错误原因:密码错误或地址无效或ETH不足!')
										} else {
											mui.toast('Success!');
											/*
											 跳转到转账成功页面,并携带转账信息!  -----待处理携带参数
											 * */
											openInfo('dealsuccessful.html');
										}
									})
							};

						})
					}
					if(currencyName == 'ETH') {
						sendEth();
						console.log('ETH转账')
					} else if(currencyName == 'TRUE') {
						sendToken(that.fromAddress, that.toAddress, that.amount, that.pwd)
						console.log('TRUE转账')
					}
				}
			});
			//关闭按钮
			$('.close').on('tap', function(e) {
				flag = true;
				mask.close();
				$('#currencyPwd').removeClass('mui-active');
				$('#modal').removeClass('mui-active');
			});
			//确定支付详情
			$('#confirmOrder').on('tap', function() {
				$('#currencyPwd').removeClass('mui-hidden');
				$('#currencyPwd').addClass('mui-active');
				//openInfo('dealsuccessful.html');
			});
		}
	};

	Validata.init();
})();