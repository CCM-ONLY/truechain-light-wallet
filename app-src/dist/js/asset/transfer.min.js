"use strict";

mui.plusReady(function() {
	(function() {
		var nameObj = GetRequest();
		var currencyName = nameObj['name'];
		//Address = nameObj['scanningAddress'];
		//		if(currencyName || scanningAddress) {
		//			h('.mui-title-transfer').html(currencyName + '转账');
		//			h('#toAddress').val(scanningAddress);
		//		}
		if(currencyName) {
			h('.mui-title-transfer').html(currencyName + '转账');
		} else {
			h('.mui-title-transfer').html('转账');
		}

		function GetRequest() {
			var url = location.search; //获取url中"?"符后的字串
			var theRequest = new Object();
			if(url.indexOf("?") != -1) {
				var str = url.substr(1);
				var strs = str.split("&");
				for(var i = 0; i < strs.length; i++) {
					theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
				}
			}
			return theRequest;
		}

		var Validata = {
			//初始化
			add: null,
			money: null,
			//	remark:null,
			cost: null,
			psw: null,
			pwd: null,
			trueContractAddr: null,
			ttrContractAddr: null,
			isEmpty: true,
			regMoney: /\d+$/, //  /(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]{3}([0-9])?$)/,
			fromAddress: null,
			toAddress: null,
			amount: null,
			//验证是否通过
			addFlag: false,
			moneyFlag: false,
			costFlag: false,
			pswFlag: false,
			init: function init() {
				this.submitForm();
			},
			checkEmpty: function checkEmpty(val) {
				if(val) {
					this.isEmpty = false;
				} else {
					this.isEmpty = true;
				}
			},
			checkAdd: function checkAdd(elements, errContainer) {
				this.addFlag = false;
				this.add = $(elements).val();
				this.checkEmpty(this.add);
				if(this.isEmpty) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("钱包地址不能为空");
					return;
				} else {
					this.addFlag = true;
					$(errContainer).addClass("mui-hidden");
					$(errContainer).text("");
					return;
				}
				return this;
			},
			checkMoney: function checkMoney(elements, errContainer) {
				this.moneyFlag = false;
				this.money = $(elements).val();
				this.checkEmpty(this.money);
				if(this.isEmpty) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("转账不能为空");
					return;
				} else if(!this.regMoney.test(this.money)) {
					$(errContainer).removeClass("mui-hidden");
					$(errContainer).text("请输入正确转账金额");
					return;
				} else {
					this.moneyFlag = true;
					$(errContainer).addClass("mui-hidden");
					$(errContainer).text("");
				}
				return this;
			},
			checkPwd: function checkPwd(elements, errContainer, mask) {
				this.pswFlag = false;
				this.pwd = $(elements).val();
				this.checkEmpty(this.pwd);
				if(this.isEmpty) {
					mui.alert('密码不能为空!');
					mask._remove();
					return;
				} else {
					this.pswFlag = true;
				}
			},
			submitForm: function submitForm() {
				var that = this;
				var flag = false;
				var mask = mui.createMask(function() {
					return flag;
				});

				let host = plus.storage.getItem('web3Host');
				let reg = /https:\/\/ropsten.infura.io/;
				if(!host) {
					host = 'https://mainnet.infura.io/';
					that.trueContractAddr = "0xa4d17ab1ee0efdd23edc2869e7ba96b89eecf9ab";
					that.ttrContractAddr = "0xf2bb016e8c9c8975654dcd62f318323a8a79d48e";
				} else if(reg.test(host)) {
					that.trueContractAddr = "0x2792d677B7Ba6B7072bd2293F64BC0C1CDe23ac1";
					that.ttrContractAddr = "0x635AfeB8739f908A37b3d312cB4958CB2033F456";
				} else {
					that.trueContractAddr = "0xa4d17ab1ee0efdd23edc2869e7ba96b89eecf9ab";
					that.ttrContractAddr = "0xf2bb016e8c9c8975654dcd62f318323a8a79d48e";
				}
				var web3 = new Web3(new Web3.providers.HttpProvider(host));

				//二维码按钮
				$('.ercode-icon').on('tap', function() {
					openInfo('../my/wallet/ercode.html');
				});

				let self = plus.webview.currentWebview();
				let address = self.address;
				if(address) {
					$('#toAddress').val(address)
				}
				//下一步
				$('#next').on('tap', function() {
					that.checkAdd('.add', '.err-add');
					that.checkMoney('.money', '.err-money');
					if(that.addFlag && that.moneyFlag) {
						flag = false;
						mask.show();
						$('#modal').addClass('mui-active');
						//$('#currencyPwd').removeClass('mui-hidden');
						//$('#currencyPwd').addClass('mui-active');
						that.amount = $('#amount').val();
						that.fromAddress = plus.storage.getItem('walletAddress');
						that.toAddress = $('#toAddress').val();
						that.minerCost = $('#minerCost').html();
						$('#toaddressItem').html(that.toAddress);
						$('#fromAddress').html(that.fromAddress);
						$('#amountItem').html(that.amount);
						$('#minerCostItem').html(that.minerCost + 'ETH');
						let string = "≈ Gas(25200) * Gas Price(" + Math.round((that.minerCost / 0.00002520) * 100) / 100 + "   gwei)";
						$('.costItem').html(string);
					}
				});

				//最后确认支付按钮(跳转到支付页面)
				$('.comfirmPsw').on('tap', function() {
					//mask.show();
					$('#modal').removeClass('mui-active');
					$('#currencyPwd').addClass('mui-hidden');
					that.checkPwd('.psw', '.err-psw', mask);
					if(that.pswFlag) {
						plus.nativeUI.showWaiting("交易进行中,请稍侯...");
						//$('#currencyPwd').addClass('mui-hidden');
						//$('#currencyPwd').removeClass('mui-active');
						//$('#modal').addClass('mui-active');										
						function sendEth() {
							var keystore = plus.storage.getItem('keystore3');
							try {
								let account = web3.eth.accounts.decrypt(keystore, that.pwd);
								web3.eth.accounts.wallet.add(account);
								let value = Number(web3.utils.toWei(that.amount, 'ether'));
								web3.eth.sendTransaction({
									from: that.fromAddress,
									to: that.toAddress,
									value: value,
									gasPrice: 21000000000,
									gas: 150000
								}, function(error, txhash) {
									if(txhash) {
										mask._remove();
										$('#toAddress').val('');
										$('#amount').val('');
										$('#psw').val('');
										mui.openWindow({
											url: 'dealsuccessful.html',
											extras: {
												fromAddress: that.fromAddress,
												toAddress: that.toAddress,
												price: that.amount
											}
										});
										plus.nativeUI.closeWaiting();
									} else {
										mui.alert('交易失败');
										plus.nativeUI.closeWaiting();
										mask._remove();
									}
									console.log(error);
									console.log(txhash);
								});
							} catch(error) {
								mui.alert('密码错误,请重新输入!');
								$('#toAddress').val('');
								$('#amount').val('');
								$('#psw').val('');
								plus.nativeUI.closeWaiting();
								mask._remove();
							}
						};
						if(currencyName == 'ETH') {
							mask.show();
							setTimeout(function() {
								sendEth();
							}, 500)
						} else if(currencyName == 'TRUE') {
							let keystore = plus.storage.getItem('keystore3');
							let amountWei = that.amount.toString();
							//mui.toast('请稍后!');
							mask.show();

							function callback() {
								mask._remove();
								$('#toAddress').val('');
								$('#amount').val('');
								$('#psw').val('');
								plus.nativeUI.closeWaiting();
							}
							setTimeout(function() {
								sendTokens(that.fromAddress, that.toAddress, amountWei, that.pwd, keystore, that.trueContractAddr, callback);
							}, 500)
							console.log('TRUE转账');
						} else if(currencyName == 'TTR') {
							let keystore = plus.storage.getItem('keystore3');
							let amountWei = that.amount.toString();
							//mui.toast('请稍后!');
							function callback() {
								mask._remove();
								$('#toAddress').val('');
								$('#amount').val('');
								$('#psw').val('');
								plus.nativeUI.closeWaiting();
							}
							mask.show();
							setTimeout(function() {
								sendTokens(that.fromAddress, that.toAddress, amountWei, that.pwd, keystore, that.ttrContractAddr, callback);
							}, 500)
							console.log('TTR转账');
						};
					}
				});
				//关闭按钮
				$('.close').on('tap', function(e) {
					flag = true;
					mask.close();
					$('#modal').removeClass('mui-active');
					$('#currencyPwd').removeClass('mui-active');
					$('#currencyPwd').addClass('mui-hidden');
				});
				//确定支付详情
				$('#confirmOrder').on('tap', function() {
					//$('#modal').addClass('mui-hidden');
					$('#currencyPwd').removeClass('mui-hidden');
					$('#currencyPwd').addClass('mui-active');
				});
			}
		};

		Validata.init();
	})();
})